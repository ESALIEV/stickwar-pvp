<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Stick War Lite PvP</title>
  <style>
    body{margin:0;background:#0b1020;color:#e9ecff;font-family:system-ui,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,button{font-size:16px;border-radius:14px;border:1px solid #2a3766;background:#0e1530;color:#e9ecff;padding:12px 14px}
    button{cursor:pointer}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #2a3766;background:#0e1530;font-size:13px;opacity:.9}
    canvas{width:100%;max-width:960px;background:#0e1530;border:1px solid #2a3766;border-radius:16px;display:block;touch-action:none}
    .panel{
      display:grid; grid-template-columns: repeat(5, 1fr);
      gap:10px; margin-top:10px;
    }
    .big{padding:16px 10px;font-weight:700}
    .tiny{opacity:.8;font-size:13px;line-height:1.4}
    .two{grid-column: span 2;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <button id="btnCreate">–°–æ–∑–¥–∞—Ç—å</button>
    <input id="inpRoom" placeholder="ROOM ID" />
    <button id="btnJoin">–í–æ–π—Ç–∏</button>
    <button id="btnReset">Reset</button>
  </div>

  <div class="row" style="margin:10px 0">
    <span class="badge" id="bConn">WS: ‚Äî</span>
    <span class="badge" id="bRoom">Room: ‚Äî</span>
    <span class="badge" id="bRole">Role: ‚Äî</span>
    <span class="badge" id="bGold">Gold: ‚Äî</span>
    <span class="badge" id="bPop">Pop: ‚Äî</span>
  </div>

  <canvas id="cv" width="1000" height="380"></canvas>

  <div class="panel">
    <button class="big" id="btnMiner">‚õè Miner<br><span style="opacity:.8">50</span></button>
    <button class="big" id="btnSword">üó° Sword<br><span style="opacity:.8">120</span></button>
    <button class="big" id="btnArcher">üèπ Archer<br><span style="opacity:.8">170</span></button>

    <button class="big" id="btnAttack">‚öîÔ∏è ATTACK</button>
    <button class="big" id="btnDefend">üõ° DEFEND</button>
  </div>

  <p class="tiny">
    –≠—Ç–æ ‚ÄúStick War Lite‚Äù: —é–Ω–∏—Ç—ã —Å–∞–º–∏ –∏–¥—É—Ç –∏ –¥–µ—Ä—É—Ç—Å—è. –¢—ã —É–ø—Ä–∞–≤–ª—è–µ—à—å —Å–ø–∞–≤–Ω–æ–º –∞—Ä–º–∏–∏ –∏ —Ä–µ–∂–∏–º–æ–º.
    –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: —Å–ø–µ—Ü-—Å–∫–∏–ª–ª (–∑–∞–º–æ—Ä–æ–∑–∫–∞/–±–∞—Ñ—Ñ), –±–æ–ª—å—à–µ —é–Ω–∏—Ç–æ–≤ –∏ –∞–ø–≥—Ä–µ–π–¥—ã.
  </p>
</div>

<script>
  const WS_URL = (location.protocol === "https:")
    ? `wss://${location.host}`
    : `ws://${location.host}`;

  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");

  const bConn = document.getElementById("bConn");
  const bRoom = document.getElementById("bRoom");
  const bRole = document.getElementById("bRole");
  const bGold = document.getElementById("bGold");
  const bPop  = document.getElementById("bPop");

  const btnCreate = document.getElementById("btnCreate");
  const btnJoin = document.getElementById("btnJoin");
  const btnReset = document.getElementById("btnReset");
  const inpRoom = document.getElementById("inpRoom");

  const btnMiner  = document.getElementById("btnMiner");
  const btnSword  = document.getElementById("btnSword");
  const btnArcher = document.getElementById("btnArcher");
  const btnAttack = document.getElementById("btnAttack");
  const btnDefend = document.getElementById("btnDefend");

  let ws = null;
  let roomId = null;
  let role = null;
  let state = null;

  function connect(){
    ws = new WebSocket(WS_URL);
    bConn.textContent = "WS: connecting‚Ä¶";
    ws.onopen = () => bConn.textContent = "WS: connected";

    ws.onmessage = (ev) => {
      const msg = JSON.parse(ev.data);
      if (msg.type === "joined"){
        roomId = msg.roomId; role = msg.role;
        bRoom.textContent = "Room: " + roomId;
        bRole.textContent = "Role: " + role;
      }
      if (msg.type === "state"){
        state = msg.state;
        if (role){
          bGold.textContent = "Gold: " + state.gold[role];
          bPop.textContent  = "Pop: " + state.pop[role] + "/" + state.popCap[role];
        }
      }
      if (msg.type === "error") alert(msg.msg);
    };

    ws.onclose = () => bConn.textContent = "WS: closed";
  }

  connect();

  btnCreate.onclick = () => ws.send(JSON.stringify({ type:"create" }));
  btnJoin.onclick = () => ws.send(JSON.stringify({ type:"join", roomId: inpRoom.value }));
  btnReset.onclick = () => ws.send(JSON.stringify({ type:"reset" }));

  function spawn(t){
    if (!roomId || !role) return alert("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π/–≤–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É");
    ws.send(JSON.stringify({ type:"spawn", unitType: t }));
  }
  btnMiner.onclick  = () => spawn("miner");
  btnSword.onclick  = () => spawn("sword");
  btnArcher.onclick = () => spawn("archer");

  btnAttack.onclick = () => ws.send(JSON.stringify({ type:"mode", value:"attack" }));
  btnDefend.onclick = () => ws.send(JSON.stringify({ type:"mode", value:"defend" }));

  function draw(){
    requestAnimationFrame(draw);
    ctx.clearRect(0,0,cv.width,cv.height);

    if (!state){
      ctx.fillStyle="#e9ecff"; ctx.font="18px system-ui";
      ctx.fillText("–ñ–¥—É state‚Ä¶ –°–æ–∑–¥–∞–π/–≤–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É", 20, 40);
      return;
    }

    const w = state.lane.w, h = state.lane.h;

    // —Ñ–æ–Ω + –∑–µ–º–ª—è
    ctx.fillStyle="#0e1530"; ctx.fillRect(0,0,w,h);
    ctx.fillStyle="rgba(255,255,255,0.05)"; ctx.fillRect(0,h-70,w,70);

    // –±–∞–∑—ã
    function drawBase(side){
      const b = state.bases[side];
      ctx.fillStyle = side==="A" ? "rgba(255,80,80,0.9)" : "rgba(80,160,255,0.9)";
      ctx.fillRect(b.x-18, h-140, 36, 90);

      // hp bar
      ctx.fillStyle="rgba(255,255,255,0.14)";
      ctx.fillRect(b.x-40, h-155, 80, 10);
      ctx.fillStyle="#c9a84c";
      ctx.fillRect(b.x-40, h-155, 80*(b.hp/650), 10);

      ctx.fillStyle="#e9ecff"; ctx.font="14px system-ui";
      ctx.fillText(side, b.x-5, h-110);
    }
    drawBase("A"); drawBase("B");

    // —Å–Ω–∞—Ä—è–¥—ã
    ctx.strokeStyle="#e8c97a"; ctx.lineWidth=3;
    for (const p of state.projectiles){
      ctx.beginPath();
      ctx.moveTo(p.x-10, h-90);
      ctx.lineTo(p.x+10, h-90);
      ctx.stroke();
    }

    // —é–Ω–∏—Ç—ã
    for (const u of state.units){
      const y = h-90; // –æ–¥–Ω–∞ –ª–∏–Ω–∏—è
      const col = u.side==="A" ? "rgba(255,80,80,0.9)" : "rgba(80,160,255,0.9)";
      ctx.fillStyle = col;
      ctx.beginPath();
      ctx.arc(u.x, y, 14, 0, Math.PI*2);
      ctx.fill();

      // hp mini
      ctx.fillStyle="rgba(255,255,255,0.12)";
      ctx.fillRect(u.x-16, y-24, 32, 5);
      ctx.fillStyle="#c9a84c";
      const maxHp = (u.type==="miner"?45:(u.type==="sword"?95:65));
      ctx.fillRect(u.x-16, y-24, 32*(u.hp/maxHp), 5);

      ctx.fillStyle="#e9ecff"; ctx.font="11px system-ui";
      ctx.fillText(u.type[0].toUpperCase(), u.x-4, y+4);
    }

    // –ø–æ–±–µ–¥–∞
    if (state.winner){
      ctx.fillStyle="rgba(0,0,0,0.55)";
      ctx.fillRect(0,0,w,h);
      ctx.fillStyle="#e9ecff"; ctx.font="bold 40px system-ui";
      ctx.fillText("–ü–æ–±–µ–¥–∏–ª: " + state.winner, 360, 190);
      ctx.font="16px system-ui";
    }
  }
  draw();
</script>
</body>
</html>
